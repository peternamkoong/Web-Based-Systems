<!DOCTYPE html>
<html>
    <head>
        <title>Kyoung Hwan Namkoong's Chatroom</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                position: absolute;
                height: 100%;
                width: 100%;
                font: 20px Helvetica, Arial;
            }
            .container-1 {
                position: relative;
                display: flex;
                height: 96%;
                width: 100%;
            }
            .container-1 div {
                border: 1px #ccc solid;
                padding: 10px;
                background-color: #fafae6;
            }
            .chat {
                flex: 3;
                order: 1;
            }
            #messages {
                height: 100%;
                overflow: auto;
                display: -webkit-flex;
                -webkit-flex-direction: column-reverse;
                flex-direction: column-reverse;
                word-wrap: break-word;
                list-style-type: none;
            }
            #messages li {
                padding: 5px 10px;
            }
            #users li {
                padding: 5px 10px;
                list-style-type: none;
            }
            .online {
                flex: 1;
                order: 2;
            }
            .container-2 {
                position: relative;
                display: flex;
                bottom: 0%;
                height: 4%;
                width: 100%;
            }
            form {
                height: 100%;
            }
            .container-2 div {
                position: relative;
                height: 100%;
            }
            .container-2 form {
                width: 100%;
            }
            form #m {
                height: 100%;
                width: 80%;
            }
            form button {
                height: 100%;
                width: 20%;
            }
        </style>
    </head>
    <body>
        <div class="container-1">
            <div class="online">
                <ul id="users"></ul>
            </div>
            <div class="chat">
                <ul id="messages"></ul>
            </div>
        </div>
        <div class="container-2">
            <form action="">
                <div class="inputBox">
                    <input id="m" autocomplete="off" /><button>Send</button>
                </div>
            </form>
        </div>
        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            $(function() {
                var socket = io.connect();
                $('form').submit(function(e) {
                    e.preventDefault(); // prevents page reloading
                    socket.emit('chat message', $('#m').val());
                    $('#m').val('');
                    return false;
                });

                socket.on('cookies', function(nick, color) {
                    let cookieUsername;
                    let cookieColor;

                    if (checkCookie()) {
                        cookieUsername = getCookie('username');
                        cookieColor = getCookie('color');
                    } else {
                        cookieUsername = nick;
                        cookieColor = color;
                        setCookie('username', nick, 7);
                        setCookie('color', color, 7);
                    }
                    socket.emit('setNick', cookieUsername);
                    socket.emit('setColor', cookieColor);
                });
                socket.on('loadHistory', function(msg) {
                    $('#messages').prepend(msg);
                });
                socket.on('message', function(date, nick, msg, color) {
                    let msg2 =
                        '<li><font color =' +
                        color +
                        '><b> ' +
                        date +
                        nick +
                        ': ' +
                        msg +
                        '</li>';
                    socket.emit('storeHistory', msg2);
                    $('#messages').prepend(msg2);
                });
                socket.on('disconnect', function(msg) {
                    let msg2 = msg + ' has disconnected.';
                    $('#messages').prepend($('<li>').text(msg2));
                });
                socket.on('nickCorrect', function(username) {
                    setCookie('username', username, 7);
                    let msg =
                        '<li><i>Your nickname has been set to <b>' +
                        username +
                        '.</i></li>';
                    $('#messages').prepend(msg);
                });
                socket.on('uniqueNick', function(message) {
                    let msg = '<li><i>' + message + '</i></li>';
                    $('#messages').prepend(msg);
                });
                socket.on('nickIncorrect', function() {
                    let msg = '<li><i>Your nickname could not be set.</i></li>';
                    $('#messages').prepend(msg);
                });
                socket.on('nickColorCorrect', function(color) {
                    setCookie('color', color, 7);
                    let msg =
                        '<li><i>your text color is has been changed.</i></li>';
                    $('#messages').prepend(msg);
                });
                socket.on('nickColorIncorrect', function() {
                    let msg =
                        '<li><i>your text color could not be changed. Make sure it is in a proper hexcolor format RRGGBB. </i></li>';
                    $('#messages').prepend(msg);
                });
                socket.on('onlineUsers', function(msg) {
                    $('#users').append($('<li>').text(msg));
                });
                socket.on('clearUsers', function() {
                    $('#users').empty();
                });
            });

            function setCookie(cname, cvalue, exdays) {
                var d = new Date();
                d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
                var expires = 'expires=' + d.toUTCString();
                document.cookie =
                    cname + '=' + cvalue + ';' + expires + ';path=/';
            }

            function getCookie(cname) {
                var name = cname + '=';
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return '';
            }

            function checkCookie() {
                var user = getCookie('username');
                if (user != '') {
                    return true;
                } else {
                    return false;
                }
            }
        </script>
    </body>
</html>
